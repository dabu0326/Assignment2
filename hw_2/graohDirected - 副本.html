<!DOCTYPE html>
<meta charset="utf-8">
<style>

.node circle {
  stroke: white;
  stroke-width: 1.5px;
  opacity: 2.0;
}

line {
  stroke:#616161;
  stroke-width: 1.5px;
  stroke-opacity: 1.0;
}

</style>
<body>
<script type="text/javascript" src="d3.js"></script>
<script>

data = {
          nodes: [
                  {size: 1446,node_count:3,name:"aa"},
                  {size: 626,node_count:1,name:"bb"},
                  {size: 6189,node_count:2,name:"cc"}

                  ],
        links: [
                  {source: 0,target: 1},
                  {source: 0,target: 2}
        

                ]
        }
d3.json("data/co_data.json", function(error, graph) {
var clickflag=0
var onClickFunction = function(d){
  var circle = d3.select(this);

  circle
      .select(".node_image")
      .attr("xlink:href","pink.png")
      .attr("x", "-32px")
      .attr("y", "-32px")
      .attr("width", node_width)
      .attr("height", node_width);

  node.append("text")
      .attr("text-anchor", "left")
      .attr("font-size", function(o){
        return isConnected(o,d)?15:0;
      })
      .attr('stroke', 'black')
      .attr("fill","#8B2323")
      .attr('stroke-width', function (d) {return 0;}) 
      .text(function(d) { return d.name; });

  node
      .select(".node_image")
      .attr("xlink:href",function(o){
        return isConnected(o,d)?"pink.png":"blue.png";
      })
      .attr("x", "-32px")
      .attr("y", "-32px")
      .attr("width", node_width)
      .attr("height", node_width); 
}
var mouseOverFunction = function(d) {
  var circle = d3.select(this);

  node
    .transition(500)
      .style("opacity", function(o) {
        return isConnected(o, d) ? 1.0 : 0.2 ;
      })
      .style("fill", function(o) {
        if (isConnectedAsTarget(o, d) && isConnectedAsSource(o, d) ) {
          fillcolor = 'green';
        } else if (isConnectedAsSource(o, d)) {
          fillcolor = 'red';
        } else if (isConnectedAsTarget(o, d)) {
          fillcolor = 'blue';
        } else if (isEqual(o, d)) {
          fillcolor = "hotpink";
        } else {
          fillcolor = '#000';
        }
        return fillcolor;
      });

  link
    .transition(500)
      .style("stroke-opacity", function(o) {
        return o.source === d || o.target === d ? 1 : 0.2;
      })
      .transition(500)
      .attr("marker-end", function(o) {
        return o.source === d || o.target === d ? "url(#arrowhead)" : "url()";
      });

  circle
    .transition(500)
      .attr("r", function(){ return 2 * node_radius(d)});
}

var mouseOutFunction = function() {
  var circle = d3.select(this);

  node
    .transition(2000);

  link
    .transition(2000);

  circle
    .transition(2000)
      .attr("r", node_radius);
}

function isConnected(a, b) {
    return isConnectedAsTarget(a, b) || isConnectedAsSource(a, b) || a.index == b.index;
}

function isConnectedAsSource(a, b) {
    return linkedByIndex[a.index + "," + b.index];
}

function isConnectedAsTarget(a, b) {
    return linkedByIndex[b.index + "," + a.index];
}

function isEqual(a, b) {
    return a.index == b.index;
}



function node_radius(d) { return Math.pow( d.size/3, 1/3); }
function node_width(d) { return 30*Math.pow( d.node_count/3, 1/3); }




var width = 3000;
var height = 1000;
var nodes;
var links;
    nodes=graph.nodes;
    links=graph.links;
    console.log(links);
    console.log(nodes);
    var force = d3.layout.force()
              .nodes(nodes)
              .links(links)
              .charge(-150)
              .linkDistance(300)
              .friction(1.0)
              .gravity(0.6)
              .size([width,height])
              .start();
var linkedByIndex = {};
links.forEach(function(d) {
  linkedByIndex[d.source.index + "," + d.target.index] = true;
});
var svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height);

var link = svg.selectAll("line")
            .data(links)
            .enter().append("line")

var node = svg.selectAll(".node")
              .data(nodes)
              .enter().append("g")
              .attr("class", "node")
              .call(force.drag);

 
/*node
  .append("circle")
  .attr("r", node_radius)
  .on("mouseover", mouseOverFunction)
  .on("mouseout", mouseOutFunction);*/

svg
  .append("marker")
  .attr("id", "arrowhead")
  .attr("refX", 6 + 7) // Controls the shift of the arrow head along the path
  .attr("refY", 2)
  .attr("markerWidth", 6)
  .attr("markerHeight", 4)
  .attr("orient", "auto")
  .append("path")
  .attr("d", "M 0,0 V 4 L6,2 Z");

link
  .attr("marker-end", "url()");

force
  .on("tick",tick);

  node
      .append("svg:image")
      .attr("xlink:href","blue.png")
      .attr("class", "node_image")
      .attr("x", "-32px")
      .attr("y", "-32px")
      .attr("width", node_width)
      .attr("height", node_width)
      .on("click", onClickFunction);

function tick() {
  link
    .attr("x1", function(d) { return d.source.x; })
    .attr("y1", function(d) { return d.source.y; })
    .attr("x2", function(d) { return d.target.x; })
    .attr("y2", function(d) { return d.target.y; });

  node.attr("cx", function(d) { return d.x; })
      .attr("cy", function(d) { return d.y; });
//  node.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
} 
});



 

</script>
<br/>
<h1><b>CoAuthor Relation Mapping</b></h1><br/>
<h2><b>过滤条件:</b></h2><br/>
每位作者的合作次数
<select name="nodeCount" id="nodeCount" onchange="refreshNetworkSettings()">
    <option value="1" selected>大于等于1次</option>
    <option value="2">大于等于2次</option>
    <option value="3">大于等于3次</option>
    <option value="4">大于等于4次</option>
    <option value="5">大于4次</option>
    <!--<option value="rect">rect</option>-->
</select>
两位作者之间的合作强度
<select name="edgeCount" id="edgeCount" onchange="refreshNetworkSettings()">
    <option value="1" selected>大于等于1次</option>
    <option value="2">大于等于2次</option>
    <option value="3">大于等于3次</option>
    <option value="4">大于等于4次</option>
    <option value="5">大于4次</option>
</select>
<h2><b>查找条件:作者姓名</b></h2>
<select name="nodeName" id="nodeName" onchange="refreshNetworkSettings()">
</select>
<input type="button" class = "button" value="Apply" onclick = "reloadNetwork()"/>
<br/> 
</body>